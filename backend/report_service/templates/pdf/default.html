<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>{{ title }}</title>
    <style>
        @page {
            size: A4;
            margin: 2cm;
        }
        body {
            font-family: Arial, sans-serif;
            line-height: 1.5;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        .section {
            margin-top: 20px;
            margin-bottom: 20px;
        }
        h1 {
            color: #2c3e50;
            font-size: 24px;
        }
        h2 {
            color: #34495e;
            font-size: 18px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .footer {
            margin-top: 30px;
            text-align: center;
            font-size: 0.8em;
            color: #7f8c8d;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
        .green {
            color: #27ae60;
            font-weight: bold;
        }
        .yellow {
            color: #f39c12;
            font-weight: bold;
        }
        .red {
            color: #e74c3c;
            font-weight: bold;
        }
        .chart {
            margin: 20px 0;
            text-align: center;
        }
        .summary {
            background-color: #ecf0f1;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>{{ title }}</h1>
        <p>Период: {{ start_date.strftime('%d.%m.%Y') }} - {{ end_date.strftime('%d.%m.%Y') }}</p>
    </div>
    
    <div class="summary">
        <h2>Сводная информация</h2>
        <p>
            <strong>Количество продуктов:</strong> {{ forecast_data|length if forecast_data else 0 }}
            <br>
            <strong>Период отчета:</strong> {{ (end_date - start_date).days + 1 }} дней
        </p>
    </div>
    
    {% if include_charts and forecast_data %}
    <div class="section">
        <h2>Прогноз спроса по статусам</h2>
        <table>
            <tr>
                <th>Статус</th>
                <th>Количество</th>
                <th>Процент</th>
            </tr>
            {% set green_count = forecast_data|selectattr('status', 'eq', 'green')|list|length %}
            {% set yellow_count = forecast_data|selectattr('status', 'eq', 'yellow')|list|length %}
            {% set red_count = forecast_data|selectattr('status', 'eq', 'red')|list|length %}
            {% set total = forecast_data|length %}
            <tr>
                <td class="green">Высокая точность</td>
                <td>{{ green_count }}</td>
                <td>{{ "%.1f"|format(green_count / total * 100) }}%</td>
            </tr>
            <tr>
                <td class="yellow">Средняя точность</td>
                <td>{{ yellow_count }}</td>
                <td>{{ "%.1f"|format(yellow_count / total * 100) }}%</td>
            </tr>
            <tr>
                <td class="red">Низкая точность</td>
                <td>{{ red_count }}</td>
                <td>{{ "%.1f"|format(red_count / total * 100) }}%</td>
            </tr>
        </table>
    </div>
    {% endif %}
    
    {% if historical_data %}
    <div class="section">
        <h2>Исторические данные</h2>
        <table>
            <tr>
                <th>Продукт</th>
                <th>Дата</th>
                <th>Фактический спрос</th>
            </tr>
            {% for item in historical_data %}
            <tr>
                <td>{{ item.product_name }}</td>
                <td>{{ item.date.strftime('%d.%m.%Y') }}</td>
                <td>{{ "%.2f"|format(item.actual_demand) }}</td>
            </tr>
            {% endfor %}
        </table>
    </div>
    {% endif %}
    
    {% if forecast_data %}
    <div class="section">
        <h2>Прогноз спроса</h2>
        <table>
            <tr>
                <th>Продукт</th>
                <th>Дата</th>
                <th>Прогноз</th>
                <th>Доверительный интервал</th>
                <th>Точность</th>
                <th>Статус</th>
            </tr>
            {% for item in forecast_data %}
            <tr>
                <td>{{ item.product_name }}</td>
                <td>{{ item.date.strftime('%d.%m.%Y') }}</td>
                <td>{{ "%.2f"|format(item.forecasted_demand) }}</td>
                <td>
                    {% if item.confidence_low is defined and item.confidence_high is defined %}
                        {{ "%.2f"|format(item.confidence_low) }} - {{ "%.2f"|format(item.confidence_high) }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if item.accuracy is defined and item.accuracy %}
                        {{ "%.2f"|format(item.accuracy * 100) }}%
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td class="{{ item.status }}">{{ item.status|upper }}</td>
            </tr>
            {% endfor %}
        </table>
    </div>
    {% endif %}
    
    <div class="footer">
        <p>Отчет сгенерирован: {{ generation_time }}</p>
        <p>DemandForecastApp - Сервис прогнозирования спроса</p>
    </div>
</body>
</html> 